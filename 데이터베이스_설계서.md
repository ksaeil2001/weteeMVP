# ê³¼ì™¸ ê´€ë¦¬ í”Œë«í¼ - ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ì„œ

**ë²„ì „**: v1.0  
**ì‘ì„±ì¼**: 2025-11-05  
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-11-05  
**ì‘ì„±ì**: AI Assistant  
**ë¬¸ì„œ íƒ€ì…**: ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜

---

## ğŸ“Œ ë¬¸ì„œ ì‘ì„± ì›ì¹™ ì¤€ìˆ˜

- âœ… **ì¤‘ë³µ ê¸ˆì§€**: ê¸°ëŠ¥ ë¡œì§ì€ ê¸°ëŠ¥ ëª…ì„¸ì„œì—ë§Œ, ê¸°ìˆ  ì„ íƒì€ ê¸°ìˆ  ìŠ¤íƒ ì„¤ê³„ì„œì—ë§Œ
- âœ… **ì¶”ìƒí™” ë ˆë²¨ ì¤€ìˆ˜**: ì´ ë¬¸ì„œëŠ” "ì–´ë–¤ ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì €ì¥í•  ê²ƒì¸ê°€" (How - Data)
- âœ… **ì˜í–¥ ë²”ìœ„ ìµœì†Œí™”**: DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ì´ ë¬¸ì„œë§Œ ìˆ˜ì •, ê¸°ëŠ¥ ëª…ì„¸ì„œëŠ” ìˆ˜ì • ë¶ˆí•„ìš”

---

## 1. ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”

### 1.1 ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„
**PostgreSQL 15** (ê¸°ìˆ  ìŠ¤íƒ ì„¤ê³„ì„œ ì°¸ì¡°)

### 1.2 ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°
```
tutoring_platform (Database)
â”œâ”€â”€ public (Schema)
â”‚   â”œâ”€â”€ users           # ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´
â”‚   â”œâ”€â”€ teachers        # ì„ ìƒë‹˜ ì¶”ê°€ ì •ë³´
â”‚   â”œâ”€â”€ students        # í•™ìƒ ì¶”ê°€ ì •ë³´
â”‚   â”œâ”€â”€ parents         # í•™ë¶€ëª¨ ì¶”ê°€ ì •ë³´
â”‚   â”œâ”€â”€ groups          # ê³¼ì™¸ ê·¸ë£¹
â”‚   â”œâ”€â”€ group_members   # ê·¸ë£¹-ì‚¬ìš©ì ê´€ê³„
â”‚   â”œâ”€â”€ invite_codes    # ì´ˆëŒ€ ì½”ë“œ
â”‚   â”œâ”€â”€ schedules       # ìˆ˜ì—… ì¼ì •
â”‚   â”œâ”€â”€ attendances     # ì¶œê²° ê¸°ë¡
â”‚   â”œâ”€â”€ lesson_records  # ìˆ˜ì—… ê¸°ë¡
â”‚   â”œâ”€â”€ textbooks       # êµì¬
â”‚   â”œâ”€â”€ progress_records # ì§„ë„ ê¸°ë¡
â”‚   â”œâ”€â”€ payments        # ì •ì‚° ì •ë³´
â”‚   â”œâ”€â”€ invoices        # ì²­êµ¬ì„œ
â”‚   â”œâ”€â”€ transactions    # ê²°ì œ ë‚´ì—­
â”‚   â”œâ”€â”€ notifications   # ì•Œë¦¼
â”‚   â””â”€â”€ settings        # ì‚¬ìš©ì ì„¤ì •
```

---

## 2. ERD (Entity Relationship Diagram)

### 2.1 í•µì‹¬ ê´€ê³„ë„ (í…ìŠ¤íŠ¸ ë²„ì „)

```
users (1) â”€â”€â”€â”€â”€< (N) group_members (N) >â”€â”€â”€â”€â”€ (1) groups
  â”‚                                              â”‚
  â”‚                                              â”‚
  â”œâ”€ teachers (1:1)                             â”‚
  â”œâ”€ students (1:1)                             â”‚
  â””â”€ parents (1:1)                              â”‚
                                                 â”‚
                                   schedules <â”€â”€â”€â”¤
                                      â”‚          â”‚
                                      â”œâ”€ attendances
                                      â”‚
                                      â””â”€ lesson_records
                                            â”‚
                                            â””â”€ progress_records

groups (1) â”€â”€â”€< (N) payments
                      â”‚
                      â”œâ”€ invoices (1:N)
                      â””â”€ transactions (1:N)

users (1) â”€â”€â”€< (N) notifications
users (1) â”€â”€â”€< (1) settings
```

### 2.2 ìƒì„¸ ê´€ê³„ ì„¤ëª…

1. **users â†’ teachers/students/parents**: 1:1 ê´€ê³„ (ì‚¬ìš©ì ì—­í• ì— ë”°ë¼ ì¶”ê°€ ì •ë³´)
2. **users â†” groups**: N:M ê´€ê³„ (group_members ì¤‘ê°„ í…Œì´ë¸”)
3. **groups â†’ schedules**: 1:N ê´€ê³„ (í•œ ê·¸ë£¹ì— ì—¬ëŸ¬ ì¼ì •)
4. **schedules â†’ attendances**: 1:1 ê´€ê³„ (ì¼ì •ë§ˆë‹¤ ì¶œê²° ê¸°ë¡ í•˜ë‚˜)
5. **schedules â†’ lesson_records**: 1:1 ê´€ê³„ (ì¼ì •ë§ˆë‹¤ ìˆ˜ì—… ê¸°ë¡ í•˜ë‚˜)
6. **lesson_records â†’ progress_records**: 1:N ê´€ê³„ (í•œ ìˆ˜ì—…ì— ì—¬ëŸ¬ ì§„ë„)
7. **groups â†’ payments**: 1:N ê´€ê³„ (ê·¸ë£¹ë§ˆë‹¤ ì—¬ëŸ¬ ì •ì‚°)
8. **payments â†’ invoices**: 1:N ê´€ê³„ (í•œ ì •ì‚°ì— ì—¬ëŸ¬ ì²­êµ¬ì„œ)
9. **payments â†’ transactions**: 1:N ê´€ê³„ (í•œ ì •ì‚°ì— ì—¬ëŸ¬ ê²°ì œ ë‚´ì—­)

---

## 3. í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ìƒì„¸

### 3.1 users (ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´) - F-001

**ëª©ì **: ëª¨ë“  ì‚¬ìš©ìì˜ ê³µí†µ ì •ë³´ ì €ì¥

```sql
CREATE TABLE users (
    -- ê¸°ë³¸ í‚¤
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì¸ì¦ ì •ë³´
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,  -- bcrypt í•´ì‹œ
    
    -- ê¸°ë³¸ ì •ë³´
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    profile_image_url VARCHAR(500),
    
    -- ì—­í• 
    role VARCHAR(20) NOT NULL,  -- 'teacher', 'student', 'parent'
    CHECK (role IN ('teacher', 'student', 'parent')),
    
    -- ìƒíƒœ
    is_active BOOLEAN DEFAULT TRUE,
    is_email_verified BOOLEAN DEFAULT FALSE,
    email_verified_at TIMESTAMP,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    
    -- ê¸°íƒ€
    language VARCHAR(10) DEFAULT 'ko',  -- F-007 ì–¸ì–´ ì„¤ì •
    timezone VARCHAR(50) DEFAULT 'Asia/Seoul'
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**ì œì•½ì¡°ê±´**:
- `email`: UNIQUE, NOT NULL (F-001 ì´ë©”ì¼ ì¤‘ë³µ ë¶ˆê°€)
- `password_hash`: NOT NULL (F-001 ë¹„ë°€ë²ˆí˜¸ í•„ìˆ˜)
- `role`: CHECK (teacher, student, parent ì¤‘ í•˜ë‚˜)

**ê´€ë ¨ ê¸°ëŠ¥**: F-001 (íšŒì›ê°€ì… ë° ë¡œê·¸ì¸), F-007 (í”„ë¡œí•„)

---

### 3.2 teachers (ì„ ìƒë‹˜ ì¶”ê°€ ì •ë³´)

**ëª©ì **: ì„ ìƒë‹˜ ì „ìš© ì •ë³´ ì €ì¥

```sql
CREATE TABLE teachers (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- ì „ë¬¸ ì •ë³´
    subjects TEXT[],  -- ê°€ë¥´ì¹˜ëŠ” ê³¼ëª©ë“¤ (ë°°ì—´)
    education TEXT,   -- í•™ë ¥
    career_years INT, -- ê²½ë ¥ (ë…„)
    introduction TEXT, -- ìê¸°ì†Œê°œ
    
    -- ìˆ˜ì—…ë£Œ ê¸°ë³¸ ì„¤ì • (F-006)
    default_hourly_rate INT,  -- ì‹œê°„ë‹¹ ê¸°ë³¸ ìˆ˜ì—…ë£Œ
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-001 (ì„ ìƒë‹˜ ì „ìš© ì •ë³´), F-006 (ê¸°ë³¸ ìˆ˜ì—…ë£Œ)

---

### 3.3 students (í•™ìƒ ì¶”ê°€ ì •ë³´)

**ëª©ì **: í•™ìƒ ì „ìš© ì •ë³´ ì €ì¥

```sql
CREATE TABLE students (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- í•™ìƒ ì •ë³´
    school_name VARCHAR(100),    -- í•™êµëª…
    grade INT,                   -- í•™ë…„
    birth_date DATE,             -- ìƒë…„ì›”ì¼
    
    -- í•™ë¶€ëª¨ ì—°ê²°
    parent_id UUID REFERENCES users(id),  -- F-002 í•™ë¶€ëª¨ ì—°ê²°
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (parent_id) REFERENCES users(id) ON DELETE SET NULL
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_students_parent_id ON students(parent_id);
CREATE INDEX idx_students_school_grade ON students(school_name, grade);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-001 (í•™ìƒ ì •ë³´), F-002 (í•™ë¶€ëª¨ ì—°ê²°)

---

### 3.4 parents (í•™ë¶€ëª¨ ì¶”ê°€ ì •ë³´)

**ëª©ì **: í•™ë¶€ëª¨ ì „ìš© ì •ë³´ ì €ì¥

```sql
CREATE TABLE parents (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- í•™ë¶€ëª¨ ì •ë³´
    relation VARCHAR(20),  -- ê´€ê³„ ('father', 'mother', 'guardian')
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-001 (í•™ë¶€ëª¨ ì •ë³´)

---

### 3.5 groups (ê³¼ì™¸ ê·¸ë£¹) - F-002

**ëª©ì **: ê³¼ì™¸ ê·¸ë£¹ ì •ë³´ ì €ì¥

```sql
CREATE TABLE groups (
    -- ê¸°ë³¸ í‚¤
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê·¸ë£¹ ì •ë³´
    name VARCHAR(100) NOT NULL,  -- ê·¸ë£¹ëª… (ì˜ˆ: "ì´í•™ìƒ ìˆ˜í•™ ê³¼ì™¸")
    subject VARCHAR(50) NOT NULL,  -- ê³¼ëª©
    description TEXT,
    
    -- ìƒì„±ì
    created_by UUID NOT NULL REFERENCES users(id),  -- ì„ ìƒë‹˜
    
    -- ìˆ˜ì—…ë£Œ ì„¤ì • (F-006)
    lesson_fee INT NOT NULL,  -- íšŒë‹¹ ìˆ˜ì—…ë£Œ
    payment_type VARCHAR(20) DEFAULT 'postpaid',  -- 'prepaid', 'postpaid'
    payment_cycle INT DEFAULT 4,  -- ì •ì‚° ì£¼ê¸° (íšŒ)
    
    -- ìƒíƒœ
    is_active BOOLEAN DEFAULT TRUE,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (payment_type IN ('prepaid', 'postpaid'))
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_groups_created_by ON groups(created_by);
CREATE INDEX idx_groups_subject ON groups(subject);
CREATE INDEX idx_groups_created_at ON groups(created_at);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-002 (ê·¸ë£¹ ìƒì„±), F-006 (ìˆ˜ì—…ë£Œ ì„¤ì •)

---

### 3.6 group_members (ê·¸ë£¹-ì‚¬ìš©ì ê´€ê³„) - F-002

**ëª©ì **: ì–´ë–¤ ì‚¬ìš©ìê°€ ì–´ë–¤ ê·¸ë£¹ì— ì†í•˜ëŠ”ì§€ ì €ì¥

```sql
CREATE TABLE group_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ì—­í• 
    member_role VARCHAR(20) NOT NULL,  -- 'teacher', 'student', 'parent'
    CHECK (member_role IN ('teacher', 'student', 'parent')),
    
    -- ìƒíƒœ
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMP,  -- ê·¸ë£¹ íƒˆí‡´ ì‹œ ê¸°ë¡
    is_active BOOLEAN DEFAULT TRUE,
    
    -- ì œì•½: í•œ ê·¸ë£¹ì— ê°™ì€ ì‚¬ìš©ì ì¤‘ë³µ ë¶ˆê°€
    UNIQUE(group_id, user_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_user_id ON group_members(user_id);
CREATE INDEX idx_group_members_role ON group_members(member_role);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-002 (ê·¸ë£¹ ë©¤ë²„ ê´€ë¦¬)

---

### 3.7 invite_codes (ì´ˆëŒ€ ì½”ë“œ) - F-002

**ëª©ì **: ê·¸ë£¹ ì´ˆëŒ€ ì½”ë“œ ì €ì¥

```sql
CREATE TABLE invite_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ì½”ë“œ
    code VARCHAR(6) UNIQUE NOT NULL,  -- 6ìë¦¬ ì½”ë“œ
    
    -- ê´€ê³„
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    created_by UUID NOT NULL REFERENCES users(id),  -- ìƒì„±í•œ ì„ ìƒë‹˜
    
    -- ëŒ€ìƒ
    target_role VARCHAR(20) NOT NULL,  -- 'student', 'parent'
    CHECK (target_role IN ('student', 'parent')),
    
    -- ìƒíƒœ
    max_uses INT DEFAULT 1,  -- ìµœëŒ€ ì‚¬ìš© íšŸìˆ˜
    used_count INT DEFAULT 0,  -- í˜„ì¬ ì‚¬ìš© íšŸìˆ˜
    expires_at TIMESTAMP NOT NULL,  -- ë§Œë£Œ ì‹œê° (ìƒì„± í›„ 7ì¼)
    is_active BOOLEAN DEFAULT TRUE,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (used_count <= max_uses)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_invite_codes_code ON invite_codes(code);
CREATE INDEX idx_invite_codes_group_id ON invite_codes(group_id);
CREATE INDEX idx_invite_codes_expires_at ON invite_codes(expires_at);
```

**ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™** (F-002 ì°¸ì¡°):
- ì½”ë“œëŠ” 6ìë¦¬ (ëŒ€ì†Œë¬¸ì + ìˆ«ì)
- ë§Œë£Œ ê¸°í•œ: ìƒì„± í›„ 7ì¼
- ì‚¬ìš© íšŸìˆ˜ ì œí•œ: ê¸°ë³¸ 1íšŒ (ì„ ìƒë‹˜ì´ ëŠ˜ë¦´ ìˆ˜ ìˆìŒ)

**ê´€ë ¨ ê¸°ëŠ¥**: F-002 (ì´ˆëŒ€ ì½”ë“œ ìƒì„± ë° ì‚¬ìš©)

---

### 3.8 schedules (ìˆ˜ì—… ì¼ì •) - F-003

**ëª©ì **: ëª¨ë“  ìˆ˜ì—… ì¼ì • ì €ì¥ (ì •ê·œ + ë³´ê°•)

```sql
CREATE TABLE schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- ì¼ì • ì •ë³´
    schedule_type VARCHAR(20) NOT NULL,  -- 'regular', 'makeup'
    CHECK (schedule_type IN ('regular', 'makeup')),
    
    -- ì‹œê°„
    scheduled_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    
    -- ë°˜ë³µ ì •ë³´ (ì •ê·œ ìˆ˜ì—…ë§Œ)
    is_recurring BOOLEAN DEFAULT FALSE,
    recurrence_rule JSONB,  -- RRULE í˜•ì‹ (ì˜ˆ: ë§¤ì£¼ ì›”/ìˆ˜/ê¸ˆ)
    parent_schedule_id UUID REFERENCES schedules(id),  -- ë°˜ë³µ ì¼ì •ì˜ ì›ë³¸
    
    -- ë³´ê°• ì •ë³´ (ë³´ê°• ìˆ˜ì—…ë§Œ)
    original_schedule_id UUID REFERENCES schedules(id),  -- ì›ë˜ ê²°ì„í•œ ì¼ì •
    makeup_reason TEXT,
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'scheduled',  -- 'scheduled', 'completed', 'cancelled'
    CHECK (status IN ('scheduled', 'completed', 'cancelled')),
    
    cancelled_at TIMESTAMP,
    cancel_reason TEXT,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_schedules_group_id ON schedules(group_id);
CREATE INDEX idx_schedules_date ON schedules(scheduled_date);
CREATE INDEX idx_schedules_type ON schedules(schedule_type);
CREATE INDEX idx_schedules_status ON schedules(status);
CREATE INDEX idx_schedules_group_date ON schedules(group_id, scheduled_date);
```

**JSONB ì˜ˆì‹œ** (recurrence_rule):
```json
{
  "frequency": "weekly",
  "interval": 1,
  "byweekday": ["MO", "WE", "FR"],
  "count": 12
}
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-003 (ìˆ˜ì—… ì¼ì • ê´€ë¦¬)

---

### 3.9 attendances (ì¶œê²° ê¸°ë¡) - F-004

**ëª©ì **: ìˆ˜ì—…ë³„ ì¶œê²° ìƒíƒœ ì €ì¥

```sql
CREATE TABLE attendances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    schedule_id UUID NOT NULL REFERENCES schedules(id) ON DELETE CASCADE,
    student_id UUID NOT NULL REFERENCES users(id),
    
    -- ì¶œê²° ìƒíƒœ
    status VARCHAR(20) NOT NULL,  -- 'present', 'late', 'absent'
    CHECK (status IN ('present', 'late', 'absent')),
    
    late_minutes INT DEFAULT 0,  -- ì§€ê° ì‹œ ëª‡ ë¶„ ëŠ¦ì—ˆëŠ”ì§€
    
    -- ë©”ëª¨
    note TEXT,  -- ê²°ì„ ì‚¬ìœ  ë“±
    
    -- ê¸°ë¡ì
    recorded_by UUID NOT NULL REFERENCES users(id),  -- ì„ ìƒë‹˜
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ì œì•½: í•œ ì¼ì •ì— í•œ í•™ìƒì˜ ì¶œê²°ì€ í•˜ë‚˜ë§Œ
    UNIQUE(schedule_id, student_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_attendances_schedule_id ON attendances(schedule_id);
CREATE INDEX idx_attendances_student_id ON attendances(student_id);
CREATE INDEX idx_attendances_status ON attendances(status);
CREATE INDEX idx_attendances_recorded_at ON attendances(recorded_at);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-004 (ì¶œê²° ê´€ë¦¬)

---

### 3.10 lesson_records (ìˆ˜ì—… ê¸°ë¡) - F-005

**ëª©ì **: ìˆ˜ì—… ë‚´ìš© ê¸°ë¡ ì €ì¥

```sql
CREATE TABLE lesson_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    schedule_id UUID NOT NULL UNIQUE REFERENCES schedules(id) ON DELETE CASCADE,
    group_id UUID NOT NULL REFERENCES groups(id),
    
    -- ìˆ˜ì—… ë‚´ìš©
    content TEXT NOT NULL,  -- ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš© (ìµœì†Œ 10ì)
    student_feedback TEXT,  -- í•™ìƒ ìƒíƒœ
    homework TEXT,  -- ìˆ™ì œ
    
    -- ì‘ì„±ì
    created_by UUID NOT NULL REFERENCES users(id),  -- ì„ ìƒë‹˜
    
    -- ê³µìœ  ìƒíƒœ
    is_shared BOOLEAN DEFAULT FALSE,  -- í•™ë¶€ëª¨ì—ê²Œ ê³µìœ  ì—¬ë¶€
    shared_at TIMESTAMP,
    
    -- ì¡°íšŒ ìƒíƒœ
    parent_viewed_at TIMESTAMP,  -- í•™ë¶€ëª¨ê°€ ì½ì€ ì‹œê°
    student_viewed_at TIMESTAMP,  -- í•™ìƒì´ ì½ì€ ì‹œê°
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_lesson_records_schedule_id ON lesson_records(schedule_id);
CREATE INDEX idx_lesson_records_group_id ON lesson_records(group_id);
CREATE INDEX idx_lesson_records_created_by ON lesson_records(created_by);
CREATE INDEX idx_lesson_records_created_at ON lesson_records(created_at);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-005 (ìˆ˜ì—… ê¸°ë¡ ì‘ì„± ë° ê³µìœ )

---

### 3.11 textbooks (êµì¬) - F-005

**ëª©ì **: ì‚¬ìš© ì¤‘ì¸ êµì¬ ì •ë³´ ì €ì¥

```sql
CREATE TABLE textbooks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- êµì¬ ì •ë³´
    title VARCHAR(200) NOT NULL,  -- êµì¬ëª…
    publisher VARCHAR(100),       -- ì¶œíŒì‚¬
    total_pages INT,              -- ì „ì²´ í˜ì´ì§€ ìˆ˜
    
    -- ì‹œì‘ í˜ì´ì§€ (ì¤‘ê°„ë¶€í„° ì‹œì‘í•˜ëŠ” ê²½ìš°)
    start_page INT DEFAULT 1,
    
    -- ìƒíƒœ
    is_active BOOLEAN DEFAULT TRUE,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_textbooks_group_id ON textbooks(group_id);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-005 (êµì¬ ê´€ë¦¬)

---

### 3.12 progress_records (ì§„ë„ ê¸°ë¡) - F-005

**ëª©ì **: ìˆ˜ì—…ë³„ ì§„ë„ ìƒì„¸ ê¸°ë¡

```sql
CREATE TABLE progress_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    lesson_record_id UUID NOT NULL REFERENCES lesson_records(id) ON DELETE CASCADE,
    textbook_id UUID NOT NULL REFERENCES textbooks(id),
    
    -- ì§„ë„
    start_page INT NOT NULL,
    end_page INT NOT NULL,
    
    -- ê³„ì‚°ëœ ì§„ë„ëŸ‰
    pages_covered INT GENERATED ALWAYS AS (end_page - start_page + 1) STORED,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (start_page > 0),
    CHECK (end_page >= start_page),
    CHECK (pages_covered > 0)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_progress_records_lesson_id ON progress_records(lesson_record_id);
CREATE INDEX idx_progress_records_textbook_id ON progress_records(textbook_id);
```

**íŠ¹ì§•**:
- `pages_covered`ëŠ” ìë™ ê³„ì‚° ì»¬ëŸ¼ (GENERATED)
- F-005 ì§„ë„ í†µê³„ ê³„ì‚°ì— ì‚¬ìš©

**ê´€ë ¨ ê¸°ëŠ¥**: F-005 (ì§„ë„ ì¶”ì )

---

### 3.13 payments (ì •ì‚° ì •ë³´) - F-006

**ëª©ì **: ì •ì‚° ë‹¨ìœ„ ì •ë³´ ì €ì¥ (ì›”ë³„/ì£¼ê¸°ë³„)

```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
    
    -- ì •ì‚° ê¸°ê°„
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    
    -- ìˆ˜ì—… ì •ë³´
    lesson_count INT NOT NULL,  -- ì‹¤ì œ ìˆ˜ì—… íšŸìˆ˜ (ì¶œì„ ê¸°ì¤€)
    lesson_fee INT NOT NULL,    -- íšŒë‹¹ ìˆ˜ì—…ë£Œ
    
    -- ê¸ˆì•¡ ê³„ì‚°
    subtotal INT GENERATED ALWAYS AS (lesson_count * lesson_fee) STORED,
    discount INT DEFAULT 0,
    total_amount INT GENERATED ALWAYS AS (subtotal - discount) STORED,
    
    -- ì •ì‚° ìƒíƒœ
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'sent', 'paid', 'cancelled'
    CHECK (status IN ('pending', 'sent', 'paid', 'cancelled')),
    
    -- ì„ ìƒë‹˜ í™•ì¸
    teacher_confirmed_at TIMESTAMP,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (lesson_count >= 0),
    CHECK (lesson_fee > 0),
    CHECK (discount >= 0)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_payments_group_id ON payments(group_id);
CREATE INDEX idx_payments_period ON payments(period_start, period_end);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_created_at ON payments(created_at);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-006 (ì •ì‚° ê³„ì‚°)

---

### 3.14 invoices (ì²­êµ¬ì„œ) - F-006

**ëª©ì **: í•™ë¶€ëª¨ì—ê²Œ ë°œì†¡í•œ ì²­êµ¬ì„œ ì •ë³´

```sql
CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    payment_id UUID NOT NULL REFERENCES payments(id) ON DELETE CASCADE,
    parent_id UUID NOT NULL REFERENCES users(id),
    
    -- ì²­êµ¬ì„œ ì •ë³´
    invoice_number VARCHAR(50) UNIQUE NOT NULL,  -- ì²­êµ¬ì„œ ë²ˆí˜¸ (TUT-2024-001)
    amount INT NOT NULL,
    due_date DATE NOT NULL,
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'sent',  -- 'sent', 'viewed', 'paid', 'overdue'
    CHECK (status IN ('sent', 'viewed', 'paid', 'overdue')),
    
    -- ì¡°íšŒ ë° ê²°ì œ
    viewed_at TIMESTAMP,
    paid_at TIMESTAMP,
    
    -- ë¦¬ë§ˆì¸ë”
    reminder_sent_count INT DEFAULT 0,
    last_reminder_sent_at TIMESTAMP,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_invoices_payment_id ON invoices(payment_id);
CREATE INDEX idx_invoices_parent_id ON invoices(parent_id);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_due_date ON invoices(due_date);
CREATE INDEX idx_invoices_invoice_number ON invoices(invoice_number);
```

**ì²­êµ¬ì„œ ë²ˆí˜¸ í˜•ì‹**: `TUT-{YYYY}-{ìˆœë²ˆ}` (ì˜ˆ: TUT-2024-001)

**ê´€ë ¨ ê¸°ëŠ¥**: F-006 (ì²­êµ¬ì„œ ë°œì†¡)

---

### 3.15 transactions (ê²°ì œ ë‚´ì—­) - F-006

**ëª©ì **: ì‹¤ì œ ê²°ì œ ê¸°ë¡ ì €ì¥

```sql
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ê´€ê³„
    invoice_id UUID NOT NULL REFERENCES invoices(id),
    payment_id UUID NOT NULL REFERENCES payments(id),
    
    -- ê²°ì œ ì •ë³´
    transaction_id VARCHAR(100) UNIQUE NOT NULL,  -- PGì‚¬ ê±°ë˜ ID
    amount INT NOT NULL,
    
    -- ê²°ì œ ìˆ˜ë‹¨
    payment_method VARCHAR(50) NOT NULL,  -- 'card', 'transfer', 'toss', 'kakao', 'naver'
    
    -- PGì‚¬ ì •ë³´
    pg_provider VARCHAR(50) DEFAULT 'tosspayments',
    pg_response JSONB,  -- PGì‚¬ ì‘ë‹µ ì „ì²´ (ë¡œê¹…ìš©)
    
    -- ìƒíƒœ
    status VARCHAR(20) NOT NULL,  -- 'pending', 'completed', 'failed', 'refunded'
    CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
    
    -- í™˜ë¶ˆ ì •ë³´
    refunded_amount INT DEFAULT 0,
    refunded_at TIMESTAMP,
    refund_reason TEXT,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_transactions_invoice_id ON transactions(invoice_id);
CREATE INDEX idx_transactions_payment_id ON transactions(payment_id);
CREATE INDEX idx_transactions_transaction_id ON transactions(transaction_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);
```

**PG ì‘ë‹µ ì˜ˆì‹œ** (pg_response):
```json
{
  "orderId": "TUT-2024-001",
  "approvedAt": "2024-11-05T15:30:00+09:00",
  "card": {
    "company": "ì‹ í•œ",
    "number": "1234****5678",
    "installmentPlanMonths": 0
  }
}
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-006 (ê²°ì œ ì²˜ë¦¬)

---

### 3.16 notifications (ì•Œë¦¼) - F-008

**ëª©ì **: ì‚¬ìš©ìì—ê²Œ ë°œì†¡í•œ ì•Œë¦¼ ì €ì¥

```sql
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ìˆ˜ì‹ ì
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ì•Œë¦¼ ì •ë³´
    type VARCHAR(50) NOT NULL,  -- 'lesson_reminder', 'payment', 'attendance', etc.
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    
    -- ë°ì´í„° (ì•± ë‚´ ë™ì‘ìš©)
    data JSONB,  -- {"screen": "lesson_detail", "lesson_id": "..."}
    
    -- ìƒíƒœ
    status VARCHAR(20) DEFAULT 'sent',  -- 'sent', 'delivered', 'read', 'failed'
    CHECK (status IN ('sent', 'delivered', 'read', 'failed')),
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    delivered_at TIMESTAMP,
    read_at TIMESTAMP,
    
    -- í‘¸ì‹œ ì •ë³´
    fcm_message_id VARCHAR(200),  -- FCMì—ì„œ ë°˜í™˜í•œ ë©”ì‹œì§€ ID
    
    -- ë§Œë£Œ
    expires_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP + INTERVAL '90 days'
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_status ON notifications(status);
CREATE INDEX idx_notifications_sent_at ON notifications(sent_at);
CREATE INDEX idx_notifications_expires_at ON notifications(expires_at);
CREATE INDEX idx_notifications_user_status ON notifications(user_id, status);
```

**íŒŒí‹°ì…”ë‹**: sent_at ê¸°ì¤€ìœ¼ë¡œ ì›”ë³„ íŒŒí‹°ì…”ë‹ (ë°ì´í„° ë§ì„ ë•Œ)

**ê´€ë ¨ ê¸°ëŠ¥**: F-008 (ì•Œë¦¼ ì‹œìŠ¤í…œ)

---

### 3.17 settings (ì‚¬ìš©ì ì„¤ì •) - F-007

**ëª©ì **: ì‚¬ìš©ìë³„ ì„¤ì • ì •ë³´ ì €ì¥

```sql
CREATE TABLE settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- ì•Œë¦¼ ì„¤ì •
    notification_enabled BOOLEAN DEFAULT TRUE,
    lesson_reminder_enabled BOOLEAN DEFAULT TRUE,
    attendance_alert_enabled BOOLEAN DEFAULT TRUE,
    payment_alert_enabled BOOLEAN DEFAULT TRUE,  -- ëŒ ìˆ˜ ì—†ìŒ (UIì—ì„œ ì œì–´)
    
    -- ì•¼ê°„ ì•Œë¦¼ ì œí•œ (F-008)
    night_mode_enabled BOOLEAN DEFAULT FALSE,
    night_start_time TIME DEFAULT '22:00:00',
    night_end_time TIME DEFAULT '07:00:00',
    
    -- ì–¸ì–´ ë° ì§€ì—­ (F-007)
    language VARCHAR(10) DEFAULT 'ko',  -- 'ko', 'en', 'ja'
    timezone VARCHAR(50) DEFAULT 'Asia/Seoul',
    
    -- ë³´ì•ˆ ì„¤ì •
    two_factor_enabled BOOLEAN DEFAULT FALSE,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ê´€ë ¨ ê¸°ëŠ¥**: F-007 (ì„¤ì • ê´€ë¦¬), F-008 (ì•Œë¦¼ ì„¤ì •)

---

## 4. ì¸ë±ìŠ¤ ì „ëµ

### 4.1 í•µì‹¬ ì¸ë±ìŠ¤ (ì´ë¯¸ ì •ì˜ë¨)

ëª¨ë“  í…Œì´ë¸”ì— ì´ë¯¸ ì£¼ìš” ì¸ë±ìŠ¤ê°€ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
- Primary Key: ìë™ ì¸ë±ìŠ¤
- Foreign Key: ì¡°ì¸ ì„±ëŠ¥ í–¥ìƒ
- ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼: created_at, status, type ë“±

### 4.2 ë³µí•© ì¸ë±ìŠ¤

íŠ¹ì • ì¿¼ë¦¬ íŒ¨í„´ì— ìµœì í™”ëœ ë³µí•© ì¸ë±ìŠ¤:

```sql
-- F-003: íŠ¹ì • ê·¸ë£¹ì˜ íŠ¹ì • ë‚ ì§œ ì¼ì • ì¡°íšŒ
CREATE INDEX idx_schedules_group_date ON schedules(group_id, scheduled_date);

-- F-004: íŠ¹ì • í•™ìƒì˜ ìµœê·¼ ì¶œê²° ì¡°íšŒ
CREATE INDEX idx_attendances_student_date ON attendances(student_id, recorded_at DESC);

-- F-006: íŠ¹ì • ê·¸ë£¹ì˜ ì •ì‚° ë‚´ì—­ ì¡°íšŒ
CREATE INDEX idx_payments_group_status ON payments(group_id, status);

-- F-008: ì½ì§€ ì•Šì€ ì•Œë¦¼ ì¡°íšŒ
CREATE INDEX idx_notifications_user_status ON notifications(user_id, status);
```

### 4.3 ë¶€ë¶„ ì¸ë±ìŠ¤

íŠ¹ì • ì¡°ê±´ë§Œ ì¸ë±ì‹±í•˜ì—¬ í¬ê¸° ì ˆê°:

```sql
-- í™œì„± ê·¸ë£¹ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_groups_active ON groups(id) WHERE is_active = TRUE;

-- ë¯¸ì™„ë£Œ ì¼ì •ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_schedules_upcoming ON schedules(scheduled_date) 
WHERE status = 'scheduled' AND scheduled_date >= CURRENT_DATE;

-- ë¯¸ê²°ì œ ì²­êµ¬ì„œë§Œ ì¸ë±ì‹±
CREATE INDEX idx_invoices_unpaid ON invoices(due_date) 
WHERE status IN ('sent', 'viewed', 'overdue');
```

---

## 5. ë°ì´í„° ë¬´ê²°ì„± ì œì•½

### 5.1 Foreign Key ì œì•½

**ON DELETE CASCADE**:
- groups ì‚­ì œ â†’ group_members, schedules, payments ë“± ìë™ ì‚­ì œ
- users ì‚­ì œ â†’ ê´€ë ¨ ëª¨ë“  ë°ì´í„° ìë™ ì‚­ì œ

**ON DELETE SET NULL**:
- parent ì‚­ì œ â†’ studentì˜ parent_idë¥¼ NULLë¡œ ì„¤ì • (í•™ìƒì€ ìœ ì§€)

### 5.2 CHECK ì œì•½

```sql
-- ì—­í•  ì œí•œ
CHECK (role IN ('teacher', 'student', 'parent'))

-- ìƒíƒœ ì œí•œ
CHECK (status IN ('pending', 'completed', 'cancelled'))

-- ë…¼ë¦¬ì  ì œì•½
CHECK (end_page >= start_page)
CHECK (lesson_count >= 0)
CHECK (discount >= 0)
```

### 5.3 UNIQUE ì œì•½

```sql
-- ì´ë©”ì¼ ì¤‘ë³µ ë°©ì§€
UNIQUE(email)

-- ì´ˆëŒ€ ì½”ë“œ ì¤‘ë³µ ë°©ì§€
UNIQUE(code)

-- ê°™ì€ ê·¸ë£¹ì— ê°™ì€ ì‚¬ìš©ì ì¤‘ë³µ ë°©ì§€
UNIQUE(group_id, user_id)

-- í•œ ì¼ì •ì— í•œ í•™ìƒì˜ ì¶œê²°ì€ í•˜ë‚˜ë§Œ
UNIQUE(schedule_id, student_id)
```

---

## 6. ì¿¼ë¦¬ ìµœì í™” ì˜ˆì‹œ

### 6.1 F-003: ì„ ìƒë‹˜ì˜ ì´ë²ˆ ì£¼ ì¼ì • ì¡°íšŒ

```sql
SELECT 
    s.id,
    s.scheduled_date,
    s.start_time,
    s.end_time,
    g.name AS group_name,
    g.subject
FROM schedules s
JOIN groups g ON s.group_id = g.id
WHERE g.created_by = :teacher_id
  AND s.scheduled_date BETWEEN :week_start AND :week_end
  AND s.status = 'scheduled'
ORDER BY s.scheduled_date, s.start_time;

-- ì‚¬ìš© ì¸ë±ìŠ¤: idx_schedules_group_date, idx_groups_created_by
```

---

### 6.2 F-004: í•™ìƒì˜ ì¶œì„ë¥  ê³„ì‚°

```sql
SELECT 
    COUNT(*) FILTER (WHERE status = 'present') AS present_count,
    COUNT(*) FILTER (WHERE status = 'late') AS late_count,
    COUNT(*) FILTER (WHERE status = 'absent') AS absent_count,
    COUNT(*) AS total_count,
    ROUND(
        COUNT(*) FILTER (WHERE status = 'present') * 100.0 / COUNT(*),
        2
    ) AS attendance_rate
FROM attendances
WHERE student_id = :student_id
  AND recorded_at >= :start_date;

-- ì‚¬ìš© ì¸ë±ìŠ¤: idx_attendances_student_date
```

---

### 6.3 F-005: êµì¬ë³„ ì§„ë„ìœ¨ ê³„ì‚°

```sql
SELECT 
    t.id,
    t.title,
    t.total_pages,
    t.start_page,
    COALESCE(SUM(pr.pages_covered), 0) AS completed_pages,
    ROUND(
        COALESCE(SUM(pr.pages_covered), 0) * 100.0 / 
        NULLIF(t.total_pages - t.start_page + 1, 0),
        2
    ) AS progress_rate
FROM textbooks t
LEFT JOIN progress_records pr ON t.id = pr.textbook_id
WHERE t.group_id = :group_id
  AND t.is_active = TRUE
GROUP BY t.id, t.title, t.total_pages, t.start_page;

-- ì‚¬ìš© ì¸ë±ìŠ¤: idx_textbooks_group_id, idx_progress_records_textbook_id
```

---

### 6.4 F-006: ì •ì‚° ê¸ˆì•¡ ìë™ ê³„ì‚°

```sql
-- 1. ì •ì‚° ê¸°ê°„ ë‚´ ì¶œì„ íšŸìˆ˜ ê³„ì‚°
WITH attendance_count AS (
    SELECT COUNT(*) AS lesson_count
    FROM attendances a
    JOIN schedules s ON a.schedule_id = s.id
    WHERE s.group_id = :group_id
      AND a.status IN ('present', 'late')
      AND s.scheduled_date BETWEEN :period_start AND :period_end
)
-- 2. ì •ì‚° ì •ë³´ ìƒì„±
INSERT INTO payments (group_id, period_start, period_end, lesson_count, lesson_fee)
SELECT 
    :group_id,
    :period_start,
    :period_end,
    ac.lesson_count,
    g.lesson_fee
FROM attendance_count ac, groups g
WHERE g.id = :group_id;

-- ì‚¬ìš© ì¸ë±ìŠ¤: idx_schedules_group_date, idx_attendances_schedule_id
```

---

### 6.5 F-008: ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜

```sql
SELECT COUNT(*) AS unread_count
FROM notifications
WHERE user_id = :user_id
  AND status IN ('sent', 'delivered')
  AND expires_at > CURRENT_TIMESTAMP;

-- ì‚¬ìš© ì¸ë±ìŠ¤: idx_notifications_user_status
```

---

## 7. ë°ì´í„° ë³´ê´€ ì •ì±…

### 7.1 ì˜êµ¬ ë³´ê´€

**ë²•ì  ìš”êµ¬ì‚¬í•­** (ì „ììƒê±°ë˜ë²•, ì „ìê¸ˆìœµê±°ë˜ë²•):
- `users`: íšŒì› ì •ë³´ (5ë…„)
- `payments`, `invoices`, `transactions`: ê±°ë˜ ê¸°ë¡ (5ë…„)

### 7.2 ê¸°ê°„ ì œí•œ ë³´ê´€

- `notifications`: 90ì¼ í›„ ìë™ ì‚­ì œ
- `invite_codes`: ë§Œë£Œ í›„ 30ì¼ ë³´ê´€ â†’ ì‚­ì œ
- `lesson_records`: ë¬´ê¸°í•œ ë³´ê´€ (ì‚¬ìš©ì ìš”ì²­ ì‹œ ì‚­ì œ)

### 7.3 Soft Delete

```sql
-- ì‚¬ìš©ì íƒˆí‡´ ì‹œ ì™„ì „ ì‚­ì œ ëŒ€ì‹  ë¹„í™œì„±í™”
UPDATE users SET is_active = FALSE WHERE id = :user_id;

-- ê·¸ë£¹ ì‚­ì œ ì‹œ ë¹„í™œì„±í™”
UPDATE groups SET is_active = FALSE WHERE id = :group_id;
```

---

## 8. ë°±ì—… ë° ë³µêµ¬ ì „ëµ

### 8.1 ë°±ì—… ì •ì±…

- **ì „ì²´ ë°±ì—…**: ë§¤ì¼ ìƒˆë²½ 3ì‹œ (AWS RDS ìë™ ë°±ì—…)
- **íŠ¸ëœì­ì…˜ ë¡œê·¸**: ì‹¤ì‹œê°„ ë³µì œ (Point-in-Time Recovery)
- **ë³´ê´€ ê¸°ê°„**: 7ì¼

### 8.2 ì¬í•´ ë³µêµ¬

- **RTO (ë³µêµ¬ ëª©í‘œ ì‹œê°„)**: 4ì‹œê°„
- **RPO (ë³µêµ¬ ì‹œì  ëª©í‘œ)**: 1ì¼
- **ë³µì œ**: ë‹¤ë¥¸ ê°€ìš© ì˜ì—­(AZ)ì— Read Replica

---

## 9. ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 9.1 Alembic ì‚¬ìš©

```bash
# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
alembic revision --autogenerate -m "create users table"

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
alembic upgrade head

# ë¡¤ë°±
alembic downgrade -1
```

### 9.2 ë²„ì „ ê´€ë¦¬

```
alembic/versions/
â”œâ”€â”€ 001_create_users_table.py
â”œâ”€â”€ 002_create_groups_table.py
â”œâ”€â”€ 003_create_schedules_table.py
â””â”€â”€ ...
```

---

## 10. ê¸°ëŠ¥ ëª…ì„¸ì„œì™€ì˜ ë§¤í•‘

| ê¸°ëŠ¥ | ì£¼ìš” í…Œì´ë¸” | ê´€ê³„ |
|------|-----------|------|
| F-001 íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ | users, teachers, students, parents | 1:1 í™•ì¥ |
| F-002 ê³¼ì™¸ ê·¸ë£¹ ìƒì„± ë° ë§¤ì¹­ | groups, group_members, invite_codes | N:M ê´€ê³„ |
| F-003 ìˆ˜ì—… ì¼ì • ê´€ë¦¬ | schedules | 1:N (ê·¸ë£¹-ì¼ì •) |
| F-004 ì¶œê²° ê´€ë¦¬ | attendances | 1:1 (ì¼ì •-ì¶œê²°) |
| F-005 ìˆ˜ì—… ê¸°ë¡ ë° ì§„ë„ ê´€ë¦¬ | lesson_records, textbooks, progress_records | 1:N (ì¼ì •-ê¸°ë¡, ê¸°ë¡-ì§„ë„) |
| F-006 ìˆ˜ì—…ë£Œ ì •ì‚° | payments, invoices, transactions | 1:N (ì •ì‚°-ì²­êµ¬ì„œ, ì²­êµ¬ì„œ-ê±°ë˜) |
| F-007 ê¸°ë³¸ í”„ë¡œí•„ ë° ì„¤ì • | users, settings | 1:1 (ì‚¬ìš©ì-ì„¤ì •) |
| F-008 í•„ìˆ˜ ì•Œë¦¼ ì‹œìŠ¤í…œ | notifications | 1:N (ì‚¬ìš©ì-ì•Œë¦¼) |

---

## 11. ì„±ëŠ¥ ì˜ˆì¸¡

### 11.1 ì˜ˆìƒ ë°ì´í„° ê·œëª¨ (1ë…„ í›„)

| í…Œì´ë¸” | ì˜ˆìƒ ë ˆì½”ë“œ ìˆ˜ | í¬ê¸° |
|--------|--------------|------|
| users | 3,000 | 1MB |
| groups | 500 | 100KB |
| schedules | 50,000 | 10MB |
| attendances | 50,000 | 5MB |
| lesson_records | 50,000 | 50MB (í…ìŠ¤íŠ¸) |
| payments | 6,000 | 1MB |
| notifications | 500,000 | 100MB |
| **ì´í•©** | **~660,000** | **~170MB** |

### 11.2 ì¿¼ë¦¬ ì„±ëŠ¥ ëª©í‘œ

- ë‹¨ìˆœ ì¡°íšŒ (PK): < 5ms
- ì¡°ì¸ ì¿¼ë¦¬ (2-3 í…Œì´ë¸”): < 50ms
- ì§‘ê³„ ì¿¼ë¦¬ (í†µê³„): < 200ms
- ì „ì²´ ìŠ¤ìº” (ê·¹íˆ ë“œë¬¼ê²Œ): < 1s

---

## 12. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 12.1 ë¯¼ê° ë°ì´í„° ì•”í˜¸í™”

- `password_hash`: bcrypt (ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨)
- `phone`, `email`: í‰ë¬¸ (HTTPSë¡œ ì „ì†¡ ì‹œ ì•”í˜¸í™”)
- ë¯¸ë˜: `phone` ì•”í˜¸í™” ê³ ë ¤ (AES-256)

### 12.2 ì ‘ê·¼ ì œì–´

- DB ì‚¬ìš©ì ê¶Œí•œ ìµœì†Œí™” (Principle of Least Privilege)
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ìš© ê³„ì •: SELECT, INSERT, UPDATE, DELETEë§Œ
- Admin ê³„ì •: DROP, ALTER ë“± DDL ê¶Œí•œ

---

## 13. ë‹¤ìŒ ë‹¨ê³„: ê¸°ëŠ¥ ëª…ì„¸ì„œ í”¼ë“œë°±

### 13.1 DB ì„¤ê³„ì—ì„œ ë°œê²¬í•œ ì´ìŠˆ

DB ì„¤ê³„ë¥¼ í•˜ë©´ì„œ ê¸°ëŠ¥ ëª…ì„¸ì„œì—ì„œ ëˆ„ë½ëœ ë¶€ë¶„ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:

**F-003 (ìˆ˜ì—… ì¼ì • ê´€ë¦¬)**:
- âœ… í•´ê²°ë¨: ë°˜ë³µ ì¼ì • ê·œì¹™ì„ `recurrence_rule` JSONBë¡œ ì €ì¥
- ğŸ’¡ ì œì•ˆ: ê¸°ëŠ¥ ëª…ì„¸ì„œì— "ë°˜ë³µ ê·œì¹™ ì˜ˆì‹œ" ì¶”ê°€ í•„ìš” (ë§¤ì£¼ ì›”/ìˆ˜/ê¸ˆ ë“±)

**F-005 (ìˆ˜ì—… ê¸°ë¡)**:
- âœ… í•´ê²°ë¨: ì§„ë„ ê¸°ë¡ì„ ë³„ë„ í…Œì´ë¸” (`progress_records`)ë¡œ ë¶„ë¦¬
- ğŸ’¡ ì œì•ˆ: ê¸°ëŠ¥ ëª…ì„¸ì„œì— "í•œ ìˆ˜ì—…ì—ì„œ ì—¬ëŸ¬ êµì¬ ì§„ë„ ê¸°ë¡ ê°€ëŠ¥" ëª…ì‹œ í•„ìš”

**F-006 (ì •ì‚°)**:
- âœ… í•´ê²°ë¨: ì •ì‚° â†’ ì²­êµ¬ì„œ â†’ ê±°ë˜ 3ë‹¨ê³„ ë¶„ë¦¬
- ğŸ’¡ ì œì•ˆ: ê¸°ëŠ¥ ëª…ì„¸ì„œì— "ì²­êµ¬ì„œ ë²ˆí˜¸ í˜•ì‹" ëª…ì‹œ í•„ìš” (TUT-YYYY-NNN)

**F-007 (í”„ë¡œí•„)**:
- âš ï¸ ë°œê²¬: ì„ ìƒë‹˜ì˜ "ë¡œê·¸ì¸ ê¸°ë¡" ì¡°íšŒ ê¸°ëŠ¥ì´ ëª…ì„¸ì„œì— ìˆì§€ë§Œ, DB í…Œì´ë¸”ì´ ì—†ìŒ
- ğŸ’¡ ì œì•ˆ: `login_history` í…Œì´ë¸” ì¶”ê°€ í•„ìš”í•˜ê±°ë‚˜, F-007ì—ì„œ ì´ ê¸°ëŠ¥ ì œê±°

### 13.2 ì¶”ê°€ í•„ìš”í•œ í…Œì´ë¸”

**login_history** (F-007 ì„ ìƒë‹˜ ë¡œê·¸ì¸ ê¸°ë¡):
```sql
CREATE TABLE login_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    ip_address VARCHAR(45),  -- IPv6 ì§€ì›
    user_agent TEXT,
    device_type VARCHAR(50),  -- 'mobile', 'tablet', 'desktop'
    
    login_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    logout_at TIMESTAMP,
    
    is_successful BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_login_history_user_id ON login_history(user_id);
CREATE INDEX idx_login_history_login_at ON login_history(login_at);
```

---

## 14. ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|------|----------|--------|
| v1.0 | 2025-11-05 | ì´ˆì•ˆ ì‘ì„± | AI Assistant |

---

## 15. ì°¸ê³  ë¬¸ì„œ

- ê¸°ëŠ¥ ëª…ì„¸ì„œ: F-001 ~ F-008
- ê¸°ìˆ  ìŠ¤íƒ ì„¤ê³„ì„œ: `ê¸°ìˆ ìŠ¤íƒ_ì„¤ê³„ì„œ.md`
- ë¬¸ì œ ì •ì˜ì„œ: `01_ë¬¸ì œ_ì •ì˜_ë°_ëª©í‘œ_ì„¤ì •.md`

---

**ì‘ì„±ì ë…¸íŠ¸**: 
ì´ DB ì„¤ê³„ëŠ” 8ê°œ ê¸°ëŠ¥ ëª…ì„¸ì„œì˜ ëª¨ë“  ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±ì‹œí‚¤ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. PostgreSQLì˜ ê³ ê¸‰ ê¸°ëŠ¥ (JSONB, GENERATED ì»¬ëŸ¼, íŒŒí‹°ì…”ë‹)ì„ í™œìš©í•˜ì—¬ í™•ì¥ì„±ê³¼ ì„±ëŠ¥ì„ ëª¨ë‘ ê³ ë ¤í–ˆìŠµë‹ˆë‹¤. ëª¨ë“  í…Œì´ë¸”ì€ ì •ê·œí™”ë˜ì–´ ìˆìœ¼ë©° (3NF), í•„ìš”í•œ ê³³ì—ë§Œ ì—­ì •ê·œí™”ë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤ (ì„±ëŠ¥ ìµœì í™”).
